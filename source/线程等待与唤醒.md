---
title: 线程等待与唤醒机制
abbrlink: 43149
categories: 
- java基础
---




## 怎么保证   输入  --  输出   一套流程  不出错?

<!--more-->

## 需要赋值的对象Resource

``` java
public class Resource {
	/**	线程等待与唤醒案例数据安全解决*/
	 public String name;
     public String sex;
     //public Boolean flag = false;
}
```

## 输入流程

``` java
public class Input implements Runnable {
	private Resource r;
	//为了保证输入输出操作的是同一个Resource对象
	public Input(Resource r) {
		this.r = r;
	}
	public void run() {
		int i = 0;
		while (true) {
				if (i % 2 == 0) {
					r.name = "张三";
					r.sex = "男";
				} else {
					r.name = "Marry";
					r.sex = "girl";
				}

			i++;
		}
	}
}
```

## 输出流程

``` java
public class Output implements Runnable {
	 private Resource r ;     
     public Output(Resource r){
       this.r = r;
     }
     public void run() {
       while(true){
         System.out.println(r.name+".."+r.sex);
       }
     }
}
```

## 执行流程

``` java
	public static void main(String[] args) {
		Resource r=new Resource();
		Input in = new Input(r);
        Output out = new Output(r);
        //分别创建输入输出线程 操作同一个r对象
        Thread tin = new Thread(in);
        Thread tout = new Thread(out);      
        tin.start();
        tout.start();
	}
```

## 结果

```
Marry..男
张三..男
张三..girl
```

出现输出异常现象!

## 产生原因

输入线程拿到cpu资源,进行赋值  张三..男   ,但在这时**输出线程并没有抢到资源**,输入线程依然占着资源,又开始赋值就在r.name赋值完成,r.sex还没赋值好的一瞬间 ,

此时变成  Marry..男  ,输出线程抢到了资源 ,打印就出现了异常问题

## 输入流程加入同步

``` java

			while (true) {
                synchronized (r) {
                        if (i % 2 == 0) {
                            r.name = "张三";
                            r.sex = "男";
                        } else {
                            r.name = "Marry";
                            r.sex = "girl";
                        }

                    i++;
                }
			}
```

## 输出也要加上同步

``` java
while(true){
       synchronized(r){  
         System.out.println(r.name+".."+r.sex);
         }
  }
```

结果一堆一堆的

```
张三..男
张三..男
张三..男
张三..男
Marry..girl
Marry..girl
Marry..girl
Marry..girl
Marry..girl
```

因为输入线程赋值此时 张三..男 此时输出线程一直抢着资源,所以一直输出一堆一堆的 张三..男  

或者输入线程一直占着资源不断赋值,而输出线程只输出一次,所以有好多次赋值都没有输出.这无法体现在控制台上

## 需要解决的问题

**一次输入一次输出**,而不是一次输入,无数次输出.交替出现 张三..男 Marry..girl

## 利用线程等待与唤醒解决问题

输入完成后等待,输出完成后等待,循环往复  ,利用永久等待wait()和唤醒notify()

输入输出用一个boolean切换, false是输入线程运行 ,true是输出线程运行

true的时候输入线程等待,false的时候输出线程等待,每次输入成功都改变标志位并唤醒输出线程,每次输出成功都改变标志位并唤醒输入线程

## 输入线程加入等待与唤醒

``` java
synchronized (r) {
				//标记是true,等待,
				if (r.flag) {
					try {
						r.wait();
					} catch (Exception e) {
					 }
				}
				if (i % 2 == 0) {
					r.name = "张三";
					r.sex = "男";
				} else {
					r.name = "Marry";
					r.sex = "girl";
				}
				//将对方线程唤醒,标记改为true
				r.flag = true;
				r.notify();
			}
```

## 输出线程加入等待与唤醒

``` java
synchronized(r){  
           //判断标记,是false,等待
         if(!r.flag){
           try{r.wait();}catch(Exception ex){}
           }
         System.out.println(r.name+".."+r.sex);
         //标记改成false,唤醒对方线程
         r.flag = false;
         r.notify();
         }
```

## 结果

```
张三..男
Marry..girl
张三..男
Marry..girl
张三..男
Marry..girl
张三..男
Marry..girl
```

## 问题解决!