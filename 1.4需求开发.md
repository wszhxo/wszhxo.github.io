## 数据库方面变更：

- sys_role角色加入评估师
- sys_auth权限表中加入获取变更记录和刷新变更记录配置接口，加入rel_menu_auth关系放在用户管理的修改用户菜单下
- 



在API模块中TemplateTypeEnum和CommonConstant中加入了配置



  =============== 车300短信接口返回结果:{"msg":"无效的业务Key:CREATE_TONGYONG_USER_EMAIL_NOTICE或应用Key:SP不匹配","code":3100,"data":[]}

INSERT INTO `delta_1.3_test`.`rel_menu_auth` (`id`, `menu_id`, `auth_id`, `create_time`, `update_time`) VALUES ('1310', '393', '1201', '2021-05-13 14:01:57', '2021-05-13 14:01:57');





```
Map<String, String> header = new HashMap<>(1);
header.put("accessToken", (String) loginApiResult.getData());
httpUtil.setHeader(header);
```



{"app_key":"SP","extra":{"email_content":["快定价用户创建失败","%用户账号%创建快定价用户失败；失败原因：%原因%"],"email_subject":["测试:测试快定价接口失败标题"]},"business_key":"CREATE_TONGYONG_USER_EMAIL_NOTICE","sn":"b7f94837015b064ffa468b3961557943","email":"hxzhang@che300.com"}



无效的业务Key:CREATE_TONGYONG_USER_EMAIL_NOTICE或应用Key:SP不匹配

```
'process.env.apiUrl': 'http://172.16.0.121:8708', // 张洪祥本地环境
```



新建字典表数据

```sql

INSERT INTO `sys_dict` ( `code`, `value`, `label`, `desc`, `rank`, `enabled`, `del_flag`, `parent_id`) VALUES ( 'user_account', '1', '变更用户账号', '变更用户记录', NULL, '1', '0', NULL);
INSERT INTO `sys_dict` ( `code`, `value`, `label`, `desc`, `rank`, `enabled`, `del_flag`, `parent_id`) VALUES ( 'user_device_id', '4', '变更用户登录设备', '变更用户记录', NULL, '1', '0', NULL);
INSERT INTO `sys_dict` ( `code`, `value`, `label`, `desc`, `rank`, `enabled`, `del_flag`, `parent_id`) VALUES ( 'user_institution', '5', '变更用户所属机构', '变更用户记录', NULL, '1', '0', NULL);
INSERT INTO `sys_dict` (`code`, `value`, `label`, `desc`, `rank`, `enabled`, `del_flag`, `parent_id`) VALUES ( 'user_id_card', '6', '变更用户身份证号', '变更用户记录', NULL, '1', '0', NULL);
```

变更记录配置数据

```sql
INSERT INTO `modify_redcord_config` ( `tables_name`, `field`, `modify_code`) VALUES ('sys_user', 'account', 'user_account');
INSERT INTO `modify_redcord_config` ( `tables_name`, `field`, `modify_code`) VALUES ( 'sys_user', 'device_id', 'user_device_id');
INSERT INTO `modify_redcord_config` ( `tables_name`, `field`, `modify_code`) VALUES ( 'sys_user', 'id_card', 'user_id_card');
INSERT INTO `modify_redcord_config` ( `tables_name`, `field`, `modify_code`) VALUES ( 'sys_user', 'institution', 'user_institution');
INSERT INTO `modify_redcord_config` ( `tables_name`, `field`, `modify_code`) VALUES ('sys_user', 'id', 'primaryKey');


```

按钮权限表数据

```sql
INSERT INTO `sys_auth` (`menu_id`, `auth_name`, `auth_path`) VALUES ('14', '获取变更记录', '/system/modifyRecord');
INSERT INTO `sys_auth` (`menu_id`, `auth_name`, `auth_path`) VALUES ('14', '刷新变更记录配置', '/system/modifyRecord/reload');

```

用上边的id替换auth_id

rel_menu_auth

```sql
INSERT INTO `rel_menu_auth` ( `menu_id`, `auth_id`) VALUES ( '61', '1234');
INSERT INTO `rel_menu_auth` (`menu_id`, `auth_id`) VALUES ('61', '1235');

```



![](https://assets.che300.com/wiki/2021-06-04/16227882268344938.png)





测试反馈：

1. 修改所属机构然后鼠标点一下身份证号输入框出现多余记录：
   1. 由于之前身份证是null，光标点击时变为“ ”空字符串，因此也被当做变更。
2. 处理变更记录拦截器空指针：
   1. 获取登录用户为空，没考虑自动结点获取不到当前用户的情况。
3. 未记录变更登录设备:  
   1. 我记录的是最后登录设备， 其实是用户设备编号。
4. 编辑用户时基本信息取消脱敏。

