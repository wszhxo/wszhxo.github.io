# 2021.3.8

入职事宜，安装相关开发软件   在Wiki上学习相关规范制度     

nacos启动报错修改bin下的startup.sh的把set MODE = "cluster" 修改为set MODE="standalone"

 拉取代码运行代码

学习业务流程

![image-20210308143939072](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210308143939072.png)



# 2021.3.9

- savePreLoanInfo发起预审：解析当前登录用户信息-》获取预审表单信息-》转换为动态字典-》转换为map-》校验VIN正确性-》根据客户类型主贷人还是担保人创建不同的客户信息-》根据身份证 + 机构id 检查客户是否存在，存在, 则根据身份证号更新客户信息  -》doCreateNewPreLoan(preLoan, user);添加进数据库-》更新文件sys_file，更新缓存和db的分享信息biz_share

```
startPreLoanProcess
```

```
 1.针对分享的预审会验证有效性
* 2.针对客户字段进行校验
* 3.黑名单客户不可进行预审    PreLoanServiceImpl-》checkInBlackList方法
* 4.预审被拒绝过的用户不可再次进行预审（30天内）PreLoanServiceImpl-》verifyCanCreatePreLoan
* 5.针对第三方要求进行校验（客户三要素是否存在）checkThirdParam
* 6.创建或更新客户（三要素+组织机构id）biz_customer_detail
```



```

PreLoanMapper-》selectPreLoanLatest


SELECT
            bpl.*
        FROM
            biz_pre_loan bpl
            LEFT JOIN biz_customer bz ON bpl.customer_id = bz.id
            LEFT JOIN sys_project sp on bpl.project_id=sp.id
            LEFT JOIN wf_task_list wtl ON bpl.pre_loan_no=wtl.identity_id
```

1475

# 2021.3.10

### 进件管理

进件订单    

客户数据  动态表单数据biz_order_customer，，biz_order_detail

进件（贷款）信息biz_order

附件资料 动态表单数据sys_page_bind_file_label，，sys_file_label，，sys_module_page，，sys_biz_field，，sys_field_bind_detail

预审信息 biz_pre_loan

订单进度wf_task_list 

# 2021.3.11



http://39.100.13.197/system/common/getNewId

http://39.100.13.197/system/user/getUserInstitutions

platformType=web&viewOnly=false&institutionId=1&projectId=235&OSVersion=1.0&frontEndVersion=1.0

platformType=web&viewOnly=false&institutionId=1&                            OSVersion=1.0&frontEndVersion=1.0





sys_dict字典表

sys_institution 机构表

sys_project  金融项目表

sys_biz_field 动态表单表

biz_customer 客户基本信息表

biz_customer_detail 客户详细信息表

biz_pre_loan 预审信息表

# 3.12

![image-20210312112756345](https://zhanghx.oss-cn-beijing.aliyuncs.com/typora300carimage-20210312112756345.png)

文件批量插入



![image-20210312150429302](https://zhanghx.oss-cn-beijing.aliyuncs.com/typora300carimage-20210312150429302.png)

分支创建https://www.cnblogs.com/jpfss/p/10929075.html

![image-20210315154723172](https://zhanghx.oss-cn-beijing.aliyuncs.com/typora300carimage-20210315154723172.png)

![image-20210315100515858](https://zhanghx.oss-cn-beijing.aliyuncs.com/typora300carimage-20210315100515858.png)

# 3.15

怎么同步数据到决策引擎的？

决策引擎结果怎么回调？



```java
// vin码校验
        checkVin(basePreLoan.getBaseFormMap().get("vinPreloan"));

  /**
     * 校验vin码
     * @param vin vin
     */
    private void checkVin(Object vin) {
        if (vin != null) {
            String vinString = (String) vin;
            if (Toolkit.isInvalid(vinString) || vinString.trim().length() != 17) {
                throw new BizException(ResultCode.VIN_WRONGFUL.getCode(), "车架号有误");
            }
            ApiResult apiResult = vinIdentificationService.checkVin(vinString);
            Integer code = apiResult.getCode();
            if (code == null || !Objects.equals(ResultCode.SUCCESS.getCode(), code)) {
                throw new BizException(ResultCode.VIN_WRONGFUL.getCode(), "车架号有误");
            }
        }
    }
```





项目启动失败，修改了配置文件的redis，datasource，

用户管理中添加了用户





/system/order/saveIncomingInfo          OrderServiceImpl

![image-20210315170929587](https://zhanghx.oss-cn-beijing.aliyuncs.com/typora300carimage-20210315170929587.png)





疑似决策引擎回调方法

![image-20210315180736974](https://zhanghx.oss-cn-beijing.aliyuncs.com/typora300carimage-20210315180736974.png)



# 3.16

疑似决策引擎  DecisionPreLoanServiceImpl

注解 ExecuteFlowAnnotation

AOP ExecuteFlowAspect

# 3.17

![image-20210317114951200](https://zhanghx.oss-cn-beijing.aliyuncs.com/typora300carimage-20210317114951200.png)

- 车300的核心竞争力：
  - 车300在汽车基础数据市场具有垄断地位
  - 汽车基础数据及二手车估值APP排行榜名列前茅
  - 汽车交易标准化核心 - 价格标准化
  - 汽车交易标准化核心 – 建立行业标准
  - 车300专注于汽车金融反欺诈
  - 汽车金融标准化核心 - 风控标准化
  - 独家数据构建汽车行业风险关系图谱
  - 车300独家风控数据 - 车辆的生命周期数据
  - 车300贷后资产监控效果 — 用数据说话
  - 车300伽马风控效果显著 - KS值0.5以上

Activiti 学习 https://www.cnblogs.com/runtimeexception/p/8961395.html

![image-20210317114145630](https://zhanghx.oss-cn-beijing.aliyuncs.com/typora300carimage-20210317114145630.png)

OrderController。createOrder发起进件到OrderServiceImpl。saveOrder

传入部署id    key+版本号+随机id，订单id，用户id

- initProcessEngine();//初始化引擎
- //执行管理，包括启动、推进、删除流程实例等
          ProcessInstance processInstance = processEngine.getRuntimeService().startProcessInstanceById(deploymentId, identityId);
- 会在ACT_RU_IDENTITYLINK中插入一条数据
- SELECT * FROM wf_flow_element  





# 3.18

![image-20210318094217965](https://zhanghx.oss-cn-beijing.aliyuncs.com/typora300carimage-20210318094217965.png)

角色bug任务 : 修改了userMapper 207行





```
private final CarPreLoanServiceImpl preLoanServiceImpl;

CarPreLoanServiceImpl preLoanServiceImpl
 this.preLoanServiceImpl = preLoanServiceImpl;
 
                 preLoanServiceImpl.checkVin(String.valueOf(f.getFieldValue()));470
                 
 
 saveOrderCustomer方法中
 
                  for (FieldValueInfo f : fieldValueInfos) {
            if ("vin".equals(f.getFormName())) {
                preLoanServiceImpl.checkVin(String.valueOf(f.getFieldValue()));
            }
        }

```

OMEGA-1768角色文字重复问题

修改SonarQube中的代码规范问题

、

# 3.19

minio文档

https://docs.min.io/cn/minio-client-complete-guide.html

minio安装

https://blog.csdn.net/weixin_44653914/article/details/108652161?utm_medium=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-2.control&dist_request_id=&depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-2.control



竞争对手分析报告

https://wenku.baidu.com/link?url=vGt5LXjVBkM8KiavxHLrrVyMx97E1T9J7sJ_OYZbR6_c0umDwvWbMITircZDqjFjEQ_ybpPEAgtw6fwPV1FJgD_yGRzLyaCO2jKa9n4z9dc2Rnd_I4R6gGC20J_V53mZr5cOdr9HQlJm3Lk8pguwEK





fiddler







## 3.26

/data2/minio/data/

## 3.29

优化sql

0.035~0.04s之间

0.1~0.2s

0.03s

0.03s

0.03



-- EXISTS(
-- SELECT
-- 			COUNT(1)
-- 		FROM
-- 			rel_user_data_range
-- 		WHERE
- 			user_id = 1 AND bo.organization_id=institution_id
 )

[include]
files = /etc/supervisor/*.conf



```
server:
  port: 8704

spring:
  application:
    name: api-service-beta
  cloud:
    nacos:
      discovery:
        # 注册中心配置
        server-addr: 127.0.0.1:8848
  #        namespace: 7e451f91-3770-424e-8e41-c7fbeb142ed4
  #        # 权限校验
  #        username: delta_dev
  #        password: 123456
  datasource:
    driver-class-name: com.mysql.jdbc.Driver
    url: jdbc:mysql://39.100.87.64:3306/delta_1.2_dev?useUnicode=true&characterEncoding=UTF-8&zeroDateTimeBehavior=convertToNull&allowMultiQueries=true&autoReconnect=true&failOverReadOnly=false&useSSL=false
    username: delta
    password: delta@1013
  redis:
    host: 118.25.27.178
    port: 6379
    database: 12
    password: sa1234
    lettuce:
      pool:
        max-idle: 5
        max-wait: 3000ms
        min-idle: 20
  servlet:
    multipart:
      # 单个文件大小限制
      max-file-size: 10MB
      # 单次请求总大小
      max-request-size: 20MB
  image:
    # 图片前缀
    prefix: http://118.25.27.178:9000/public/

# 三方接口配置
thirdParty:
  isTest:
    #标识是否为测试环境
    switch: true
  # 中行
  boc:
    url: https://cloud.bankofchina.com/js/jstest/consumewebtest
    thirdsOrder: ${thirdParty.boc.url}/channel/thirdsOrder
    uploadImg: ${thirdParty.boc.url}/channel/uploadImgOther
    uploadVideo: ${thirdParty.boc.url}channel/uploadVideoOther
    thirdOrderFinish: ${thirdParty.boc.url}/channel/thirdOrderFinish
    thirdOrderSearch: ${thirdParty.boc.url}/channel/thirdOrderSearch
    login: ${thirdParty.boc.url}/login4
    DESKey: zgyhsfjc
    proNo: PRD01
    channel: 002
    telephone: 18751900012
    password: abc123
    code: ZJ0000107
  # 徽商
  huishang:
    request-url: http://39.100.13.197/hs/
    hs-submit: /hsuc/dorado/carAdvance.do
    hs-query: /hsuc/dorado/carAdvanceQuery.do
    hs-incoming: /hsuc/dorado/webservice/terminalDetail
    hs-incoming-query: /hsuc/dorado/query/SNI.do

  # 伽马风控
  gamma:
    token: a36b7d4d4611c99e0b6c396e309edaff
    request-url: http://testapi.che300.com
    common-eval: /service/common/eval
    api-name:
      # 贷前注册
      request-preLoan: requestPreLoanAntiFraud
      check-preLoan: checkPreLoanAntiFraudResult

  # 车型库
  che300-car-model:
    token: a36b7d4d4611c99e0b6c396e309edaff
    request-url: http://testapi.che300.com/service
    common-eval: /common/eval
    getNewCarPrice-url: /getNewCarPrice

  # VIN识别
  vin-identification:
    token: 8d0d3ea4114cb7a33e7ffb45e089984e
    request-url: http://testapi.che300.com
    identifyModel: /service/identifyModelByVIN

  # 通用车辆评估
  car-assess:
    request-url: http://39.100.87.64
    orderList: /sdk/vehicleEval/order/list/v2
    orderDetail: /api/order/detail
    orderStatus: /sdk/vehicleEval/order/getOrderStatus
    system-name: huishang
    isAccidentCar: 0


  # ocr 识别
  ocr:
    request-url: http://open.ceshi.che300.com
    # 身份证识别
    ocr-identityCard: /api/ai/id
    # 行驶证识别
    ocr-identifyDriveLicense: /api/car/identify_driver_card
    # 检测VIN 码是否有效
    car-checkVin: /api/car/check_vin
    # 银数
    uibs:
      request-url: http://10.41.3.62:58084
      api-name:
        get-token: /UIBS/BioAssay/getToken
        biopsy: /UIBS/BioAssay/BioAssay
        # 最大视频大小（MB）
        max-file-size: 15
      #视频临时文件
      video-temp-path: home/temp/
      # 银数身份核查接口
      portrait-compare:
        request-url: https://cda.cupdata.com/uibs-opentest/api/ic
        private-key: qazwsx12
  # minio配置
  minio:
    base-url: http://118.25.27.178:8180
    get-file-url: ${thirdParty.minio.base-url}/minio/object/getDownloadUrl
    delete-file: ${thirdParty.minio.base-url}/minio/object/delete
    upload-file: ${thirdParty.minio.base-url}/minio/object/upload
    batch-delete: ${thirdParty.minio.base-url}/minio/object/batchDelete
    prefix-batch-delete: ${thirdParty.minio.base-url}/minio/object/prefix/batchDelete
    html2pic:
      url: ${thirdParty.minio.base-url}/transfer/htmlToImage
    notice:
      url: http://39.100.13.197/api/open/v1/minIoGammaReportPicNotice
      token: b5a1f904c2b241e580590541bf19f874
    token-key: aa233f264db4367f
    secret: LNJzGVJxe6pztHSg
    bucket-name: public

  # 车300
  che300:
    request-url: http://open.che300.com
    # 短信/邮件接口
    sms-email:
      api-name: /api/sm
    cp:
      app-key: SP
      app-secret-key: 15dU55929PiX0Yba
      business-key: CUSTOMER_PRE_CAPTCHA
    idCard:
      request-url: http://testapi.che300.com/service/common/eval
      api-name: identifyIdCard
      token:
        #徽商测试
        hs-token: a36b7d4d4611c99e0b6c396e309edaff
        #中行测试
        zh-token: 61cffab4de472b429d1d85111c6c2fd5
    #决策引擎
    decision-engine:
      common-url: http://www.che300.club
      request-url: ${thirdParty.che300.decision-engine.common-url}:8854/gray
      api-name: /front/receiver/offline
      incoming-category-id: 1811
      incoming-access:
        api-name: /front/event/start
        event-id: hsIncomingAccess
      pre-loan:
        url: ${thirdParty.che300.decision-engine.request-url}/edsp/kjj/antiFraud
        token: KszbPKivnilMu5DlokCt
      # 事故车
      accident-car:
        url: ${thirdParty.che300.decision-engine.request-url}/front/receiver/offline
        category-id: 10012
        #贷后监控报告
      post-loan:
        url: ${thirdParty.che300.decision-engine.request-url}/edsp/query/extds/
        token: KszbPKivnilMu5DlokCt
        #主贷人目录id
      pre-principal-category-id: 1822
      #担保人目录id
      pre-guarantor-category-id: 3583
      # 家装分期预审目录id
      decorate-pre-loan-category-id: 3632
      # 家装分期进件目录
      decorate-incoming-category-id: 3632
    ocr:
      car-registration:
        request-url: https://testapi.che300.com/service/registerLicenseOCR
  # 百度地图的地址转换接口
  baidu:
    map:
      address-url: http://api.map.baidu.com/geocoding/v3/
      # 逆地理位置编码
      url: http://api.map.baidu.com/reverse_geocoding/v3
      # 经纬度转换
      convert-url: http://api.map.baidu.com/geoconv/v1/
      ak: 6gGFshckQoUHjcoa0bU4svNmrOpW6YzW

# 回调接口配置
callback:
  huishang:
    # 徽商回调token
    token: 954c6e6bcb0d4e3e810ce7d3947ec5ed

mybatis:
  mapper-locations: classpath:mybatis/mapper/*/*.xml
  config-location: classpath:mybatis/mybatis-config.xml

logging:
  # log4j2日志配置
  config: classpath:log4j2.xml

```

```
server:
  port: 8708

spring:
  application:
    name: gateway-beta
  jackson:
    date-format: yyyy-MM-dd HH:mm:ss
    time-zone: GMT+8
  redis:
    host: 118.25.27.178
    port: 6379
    database: 8
    password: sa1234
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848
    gateway:

      discovery:
        locator:
          enabled: true
      routes:
        # test service
        - id: test-SERVICE
          uri: lb://test-service
          predicates:
            - Path=/test/**
          filters:
            - StripPrefix=1
        # api service
        - id: API-SERVICE
          uri: lb://api-service-beta
          predicates:
            - Path=/api/**
          filters:
            - StripPrefix=1
        # system service
        - id: SYS-SERVICE
          uri: lb://sys-service-beta
          predicates:
            - Path=/system/**
          filters:
            - StripPrefix=1


logging:
  config: classpath:log4j2.xml

ha:
  serviceProviderDataId: serveice-providers.json

statusCode:
  serviceProviderDataId: serveice-providers.json
```

```
server:
  port: 8702

spring:
  application:
    name: sys-service-beta
  jackson:
    # 配置全局Date类型返回格式
    date-format: yyyy-MM-dd HH:mm:ss
    time-zone: GMT+8
  aop:
    proxy-target-class: true
  cloud:
    nacos:
      discovery:
        # 注册中心配置
        server-addr: 127.0.0.1:8848
  #        namespace: f628db7e6b
  #        # 权限校验
  #        username: delta
  #        password: 123456
  datasource:
    driver-class-name: com.p6spy.engine.spy.P6SpyDriver
    url: jdbc:p6spy:mysql://39.100.87.64:3306/delta_1.2_dev?useUnicode=true&characterEncoding=UTF-8&zeroDateTimeBehavior=convertToNull&allowMultiQueries=true&autoReconnect=true&failOverReadOnly=false&useSSL=false
    username: delta
    password: delta@1013
  redis:
    host: 118.25.27.178
    port: 6379
    database: 12
    password: sa1234
    lettuce:
      pool:
        max-idle: 5
        max-wait: 3000ms
        min-idle: 20
  servlet:
    multipart:
      # 单个文件大小限制
      max-file-size: 10MB
      # 单次请求总大小
      max-request-size: 20MB
  # activiti流程引擎配置
  activiti:
    check-process-definitions: false
    database-schema: delta_beta
    database-schema-update: flase
    db-identity-used: false
    async-executor-activate: false
    history-level: audit
  image:
    prefix: http://118.25.27.178:9000/public/
    platform:
      baseUrl: http://10.98.14.61:8080
      gateWay: /open-api/api
      uploadUrl: /upload/H5UploadPage
      showUrl: /upload/H5ViewPage
      getImages: /upload/GetImageByImageIds
      getImagesByBusinessId: /upload/GetImagesByBusinessNo
  # 伽马贷后接口
  gamma:
    url: http://testapi.che300.com/service/common/eval
    token: a36b7d4d4611c99e0b6c396e309edaff
    switch: true

thirdParty:
  # 徽商简易风险推送
  huishang:
    isPush: true
    request-url: http://39.100.13.197/hs
    riskUrl: /hsuc/dorado/alertor.do
  gps:
    # 万位
    ww-gps-token: tzcdx2sptbry5hp64jyltxbmpjf8c0kd
    ww-gps-order-url: http://114.67.94.187:15000/api/dms/dd/add
    ww-gps-cancel-url: http://114.67.94.187:15000/api/dms/dd/cancel
    ww-gps-view-url: http://114.67.94.187:15000/api/dms/dd/query
    ww-gps-equipment-url: http://114.67.94.187:15000/api/dd/device
    ww-gps-track-url: http://114.67.94.187:15000/api/dd/trail

  car-assess:
    system-name: huishang

  decision-engine:
    risk-category-id: 3631
#发短信/邮件
sendMessage:
  decision:
    mobiles: empty
    emailAddresses: omega_notify@che300.com
  reboot: # 重启进件通知人
    environment: 测试
    mobiles: empty
    emailAddresses: omega_notify@che300.com
  decision-fail:
    email-addresses: omega_notify@che300.com
  portrait-compare: #身份核查失败
    email: ryli@che300.com,hcwang@che300.com,myliu@che300.com
  #伽马报告网页截图
  gamma-report-pic:
    email: ryli@che300.com,myliu@che300.com

callback:
  huishang:
    token: 954c6e6bcb0d4e3e810ce7d3947ec5ed

mybatis:
  mapper-locations: classpath:mybatis/mapper/*/*/*.xml
  config-location: classpath:mybatis/mybatis-config.xml

spring.mvc.view:
  prefix: /
  suffix: .html

assign:
  bigDataQueryCount: 4

logging:
  config: classpath:log4j2.xml

```







http://172.16.0.121:8708/system/project/saveProjectInfo

http://172.16.0.121:8708/system/bizField/getBizFieldLabel

http://172.16.0.121:8708/system/bizField/getBizField

![image-20210330150156521](https://zhanghx.oss-cn-beijing.aliyuncs.com/typora300carimage-20210330150156521.png)

## 动态表单

>  预审动态表单
>
> 在sys_biz_field中加入了产品合作商zhx
>
>   sys_field_label的field_code 一对多 sys_biz_field的super_class   表示预审字段的动态表单
>
> sys_field_bind-detail多对多  金融项目的id和sys_field_label的id
>
> 在rel_user_data_range加入数据范围多对多关系
>
> 在CarPreLoanMapper.xml中的savePreLoanBaseInfo加入字段，getPreLoanInfo加入字段
>
> 在实体类com.che300.common.entity.BizPreLoan加入了字段
>
> 在DynamicFormConstant中加入常量字段
>
> 
>
> 客户动态表单biz_customer,biz_customer_detail
>
> 除了上述操作外
>
> 需要在biz_project_partners中加入多对多关系

```
factory.setAttribute(XMLConstants.ACCESS_EXTERNAL_DTD, ""); 
factory.setAttribute(XMLConstants.ACCESS_EXTERNAL_SCHEMA, ""); 
```







![image-20210331163657351](https://zhanghx.oss-cn-beijing.aliyuncs.com/typora300carimage-20210331163657351.png)









```
saveProjectPartner
copyProjectPartners
```

RiskHitRuleMapper.xml的741行



## 4.6

改sonar

## 4.7

先从wf_process_bind得到deployment_id用其得 wf_flow_element的数据wf_task_list

改sonar

## 4.8

sql优化思路

驱动表   left  join   被驱动表   驱动表查询数据越少   被驱动表也就越少

where执行顺序是从左往右执行的，过滤量大的条件放左边



## 4.12

快进件APP   伽马智能业务中台
http://fezz.ceshi.che300.com/fms/#/user/login
http://fezz.dev.che300.com/fms/#/user/login
15061131358  123456
方便银行进行二手车，新车或者新房贷款服务，你如果你想买二手车或者新房装修贷款，就可以用这个app，首先要对你个人资产和信用做一系列审核
流程就是先对你的基本信息做审核，管理员就用这个管理中台审核通过之后，就可以进一步填写你要贷款的车辆，个人资产进行贷款，交给银行的管理员审核，最后就发放贷款。
因为二手车存在一些隐患，我们有专门的评估师对二手车评估保证不存在事故车，二次抵押车辆，我们还会安装GPS在二手车上，并对二手车进行一系列监控，保证用户要贷款的二手车是让人放心的。

SpringBoot  SpringCloud  Mybatis Redis Mysql
负责项目版本迭代，相关接口开发，

1，明确项目是做什么的
2，明确项目的价值。（为什么做这个项目，它解决了用户什么痛点，它带来什么价值？）
3，明确项目的功能。（这个项目涉及哪些功能？）
4，明确项目的技术。（这个项目用到哪些技术？）
5，明确个人在项目中的位置和作用。（你在这个项目的承担角色？核心开发？小组leader等）
6，明确项目的整体架构。
7，明确项目的优缺点，如果重新设计你会如何设计。
8，明确项目的亮点。（这个项目有什么亮点？）
9，明确技术成长。（你通过这个项目有哪些技术成长？）
10，在项目中遇到过那些问题，最后怎么解决了？（这个其实就是让你自己出题自己回答）