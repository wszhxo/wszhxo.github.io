

sys_user 的data_auth  2当前机构 3当前用户

MsgPushServiceImpl 的saveProLoanResultPushMsg

info_push_msg

```sql
CREATE TABLE `info_push_msg` (
  `id` int(32) NOT NULL AUTO_INCREMENT COMMENT 'id',
  `user_id` varchar(64) NOT NULL COMMENT '用户id',
  `msg` text NOT NULL COMMENT '推送消息',
  `msg_type` varchar(12) DEFAULT NULL COMMENT '消息类型 0：系统信息， 1：预审结果通知， 2：评估被驳回，3：评估被拒绝，4：进件被驳回，5：进件结果通知，6.评估通过',
  `business_id` varchar(34) DEFAULT NULL COMMENT '业务id',
  `business_status` varchar(12) DEFAULT NULL COMMENT '业务信息状态',
  `source` varchar(12) NOT NULL COMMENT '消息来源',
  `push_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `read_status` tinyint(4) DEFAULT '0' COMMENT '阅读状态 0:未读 1：已读',
  `extra_info` varchar(32) NOT NULL DEFAULT '-' COMMENT '额外信息',
  PRIMARY KEY (`id`) USING BTREE
) ENGINE=InnoDB AUTO_INCREMENT=1121 DEFAULT CHARSET=utf8;

```





```java

CREATE TABLE `rel_institution_msg` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT 'ID',
  `institution_id` int(11) DEFAULT NULL COMMENT '机构ID',
  `msg_id` int(11) DEFAULT NULL COMMENT '消息ID',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`) USING BTREE
) ENGINE=InnoDB AUTO_INCREMENT=35505 DEFAULT CHARSET=utf8mb4 COMMENT='机构消息表';




CREATE TABLE `rel_user_msg` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT 'ID',
  `user_id` int(11) DEFAULT NULL COMMENT '用户ID',
  `msg_id` int(11) DEFAULT NULL COMMENT '消息ID',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`) USING BTREE
) ENGINE=InnoDB AUTO_INCREMENT=35505 DEFAULT CHARSET=utf8mb4 COMMENT='用户已读消息表';

```



原来的getRecentPushMsg的sql加入多对多关系



应用名称：

zhx

平台：

Android

Appkey：

6076605d5844f15425d306ad

复制

SDK下载地址：

https://developer.umeng.com/sdk

帮助文档地址：

https://developer.umeng.com/docs/67966/detail/99884

产品视频介绍：

https://info.umeng.com/course/list?category=34%2C40&page=1&pageSize=8





{"policy":{"expire_time":"2021-04-17 11:46:41"},"description":"dddddd","production_mode":false,"appkey":"6076605d5844f15425d306ad","payload":{"body":{"title":"zhx测试","ticker":"zhx测试","text":"哈哈哈","after_open":"go_app","play_vibrate":"false","play_lights":"true","play_sound":"true"},"display_type":"notification"},"mipush":true,"mi_activity":"cccc","type":"broadcast","timestamp":"1618372348574"}





安卓：
生产：5d2c45ad570df399f500112f   db0f31d460a2dd49250169e5cf3377de
测试：5d4a75773fc195eff4000059   52310390f7d081820b7e09c251546929
iOS：不区分生产和测试
5d2c62774ca357920c000838







http://gitlab.devops.guchele.com/bussiness/delta.git

http://gitlab.devops.guchele.com/bussiness/delta.git



```java
CREATE TABLE `biz_repay_state` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
   `curTerm` int(2) DEFAULT NULL COMMENT '期号',
  `loanIousNo` varchar(32) DEFAULT NULL COMMENT '贷款借据号',
    `curPayAmt` decimal(18,2) DEFAULT NULL COMMENT '还款金额',
  `insertTime` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '入库时间',
  PRIMARY KEY (`id`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='还款情况';

```





```
//新增消息，已读未读状态
boolean res = msgPushMapper.savePushMsg(msgInfo)>0;
String table = AuditResultType.getByBusinessNo(orderNo).getTable();
int orgId= msgPushMapper.getOrgByOrderNo(orderNo,table);
List<Integer> userIds=  msgPushMapper.getUserIdByOrgId(orgId);
boolean readStatus =msgPushMapper.saveUserMsg(msgInfo.getId(),userIds)>0;
```



POSThttp://msg.umeng.com/api/send{"appkey":"6076605d5844f15425d306ad","timestamp":"1618902628719","type":"customizedcast","alias":"18006","alias_type":"alias_type","payload":{"display_type":"notification","body":{"ticker":"ticker","title":"title","text":"text","after_open":"go_activity","activity":"xxx"}},"policy":{"expire_time":"2021-04-20 18:24:42"},"description":"description-Android"}y7ykudst6ysmbfkvdavmmhkczunrpkoh







```
public interface IPreLoanSysService {
    @PostMapping(value = "/openApi/preLoan/submitPreLoan", consumes = "application/json", produces = "application/json")
    ApiResult<Object> submitPreLoanInfo(@RequestBody OpenPreLoanDTO openPreLoanDTO);

    @PostMapping("/openApi/preLoan/queryPreLoanStatus")
    ApiResult<Object> queryPreLoan(@RequestParam("businessNo") String businessNo);

    @PostMapping(value = "/openApi/preLoan/getProjectList", consumes = "application/json", produces = "application/json")
    ApiResult<Object> getProjectList(@RequestBody BaseDTO baseDTO);
}
```



```
public interface IOpenPreLoanService {
    String submitPreLoanInfo(OpenPreLoanDTO openPreLoanDTO);

    ThirdNotice queryPreLoan(String businessNo);

    List<ProjectInfoExtend> getProjectList(BaseDTO baseDTO);
}
```





```
@Bean
public IPreLoanSysService preLoanSysService(Contract contract, Decoder decoder, Encoder encoder) {
    return Feign.builder().contract(contract)
            .encoder(encoder).decoder(decoder).client(feignClient)
            .errorDecoder(errorDecoder)
            .target(IPreLoanSysService.class, "http://sys-service-beta" + environment.getProperty("delta.version"));
}
```





```
//    @Bean
//    public UmengService umengSysService(Contract contract, Decoder decoder, Encoder encoder) {
//        return Feign.builder().contract(contract)
//                .encoder(encoder).decoder(decoder).client(feignClient)
//                .errorDecoder(errorDecoder)
//                .target(UmengService.class, "http://sys-service-beta" + environment.getProperty("delta.version"));
//    }
```





ALTER TABLE sys_user ADD COLUMN last_login_client tinyint(2) UNSIGNED NOT NULL DEFAULT 0 COMMENT '平台标记： 1：ios 2：android'





CREATE TABLE `rel_user_wsmsg` (
`id` int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT 'ID',
  `user_id` int(11) unsigned NOT NULL DEFAULT '0' COMMENT '用户ID',
  `msg_id` int(11) unsigned NOT NULL DEFAULT '0' COMMENT '消息ID',
  `read_status` tinyint(4) NOT NULL DEFAULT '0' COMMENT '阅读状态 0未读  1已读',
  `del_flag` tinyint(4) NOT NULL DEFAULT '0' COMMENT '删除标记位 0未删除  1已删除',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '修改时间',
  PRIMARY KEY (`id`) USING BTREE
) ENGINE=InnoDB    COMMENT='pc端用户已读未读消息表';
alter table rel_user_msg add unique index unq_userid_msgid_readstatus(user_id,msg_id,read_status);





消息id    消息类型  设备类型



   消息类型如果是系统公告全部用户否则消息id查关联表查出用户 



{
   "lastLoginClient":1,
"msgId":1,
   "msgType":1

}



/system/msgPush/testUmeng





{

  "pushMsgInfo": {

​    "msg": "人世间最美的美男子",

​    "msgType": 0

  },

  "currentUser": {

​    "userId":18006,

​    "dataAuth":2,

​    "institutionId":1,

​     "lastLoginClient":2

  },

  "bizAnnouncement":{

​    "announcementTitle":"xxxxxx",

​    "id":456

  }

  

}





pc端消息通知读的

![image-20210423114308384](https://zhanghx.oss-cn-beijing.aliyuncs.com/typora300carimage-20210423114308384.png)

备份

```
package com.che300.api.module.thirdparty.umeng.service.impl;

import com.alibaba.fastjson.JSONObject;
import com.che300.api.common.model.ApiConstant;
import com.che300.api.module.thirdparty.umeng.pojo.UmengVo;
import com.che300.api.module.thirdparty.umeng.service.UmengService;
import com.che300.api.module.thirdparty.umeng.util.*;
import com.che300.api.module.thirdparty.user.service.IUserCommonService;
import com.che300.common.exception.BizException;
import com.che300.common.model.ResultCode;
import org.apache.commons.lang.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;

import java.util.List;
@Service
public class UmengServiceImpl implements UmengService {

    private static final Logger logger = LoggerFactory.getLogger(UmengServiceImpl.class);
    @Value("${umeng.Android.appkey}")
    private String AndroidAppkey ;
    @Value("${umeng.Android.appMasterSecret}")
    private String AndroidAppMasterSecret ;
    @Value("${umeng.IOS.appkey}")
    private String IOSAppkey ;
    @Value("${umeng.IOS.appMasterSecret}")
    private String IOSAppMasterSecret ;
    PushClient client=new PushClient();
    private String requestUrl = null;
    private String timestamp = null;
    private String aliasType = "aliasType";
    @Autowired
    IUserCommonService userCommonService;
    @Override
    public JSONObject umengPush(UmengVo umengVo) throws Exception {
        JSONObject submitParam;
        Integer lastLoginClient = umengVo.getLastLoginClient();
        if (lastLoginClient.equals(ApiConstant.ANDROID)){
            submitParam= this.androidInitParam(umengVo);
        }else if(lastLoginClient.equals(ApiConstant.IOS)){
            submitParam = this.iosInitParam(umengVo);
        }else if(lastLoginClient.equals(ApiConstant.WEB)){//系统通知 广播
            //Todo 广播消息
//            this.broadcast(umengVo);
        }else {
            throw new BizException(ResultCode.LASTLOGINCLIENT);
        }
        return null;
    }

    private void broadcast(UmengVo umengVo) throws Exception {
        List<Integer> userIds = userCommonService.getUserIds();
        String ids= StringUtils.join(userIds, ",");
        umengVo.setUserIds(ids);
        androidBroadcast(umengVo);
        iosBroadcast(umengVo);
    }
    private JSONObject iosBroadcast(UmengVo umengVo) throws Exception {
        String userIds = umengVo.getUserIds();
        String msg= umengVo.getMsg();
        IOSBroadcast customizedcast = new IOSBroadcast(IOSAppkey,IOSAppMasterSecret,umengVo.getMsgType());
        customizedcast.setAlert(msg);
        //alert的值设置为字典
//        customizedcast.setAlert("今日天气" , "" , "今日可能下雨🌂");
        customizedcast.setBadge( 0);
        customizedcast.setSound( "default");
        customizedcast.setTestMode();//测试模式
        return client.send(customizedcast,umengVo.getMsgType());
    }

    private JSONObject androidBroadcast(UmengVo umengVo) throws Exception {
        String userIds = umengVo.getUserIds();
        String msg= umengVo.getMsg();
        AndroidBroadcast customizedcast = new AndroidBroadcast(AndroidAppkey,AndroidAppMasterSecret,umengVo.getMsgType());
//        String ids=StringUtils.join(userIds, ",");
        customizedcast.setTicker(msg);
        customizedcast.setTitle( "消息通知");
        customizedcast.setText(msg);
        customizedcast.goAppAfterOpen();
        customizedcast.setDisplayType(AndroidNotification.DisplayType.NOTIFICATION);
//        customizedcast.setProductionMode();
        customizedcast.setTestMode();
        //厂商通道相关参数
//        customizedcast.setChannelActivity("your channel activity");
//        customizedcast.setChannelProperties("abc");
        return client.send(customizedcast,umengVo.getMsgType());

    }

    private JSONObject iosInitParam(UmengVo umengVo) throws Exception {
        String userIds = umengVo.getUserIds();
        String msg= umengVo.getMsg();
        IOSCustomizedcast customizedcast = new IOSCustomizedcast(IOSAppkey,IOSAppMasterSecret,umengVo.getMsgType());

        if (userIds.split(",").length>500){
            String fileId = client.uploadContents(AndroidAppkey,AndroidAppkey,"aa"+"\n"+"bb"+"\n"+"alias");
            customizedcast.setFileId(fileId, "alias_type");
        }else{
            customizedcast.setAlias(userIds, "userAlias");
        }
        customizedcast.setAlert(msg);
        //alert的值设置为字典
//        customizedcast.setAlert("今日天气" , "" , "今日可能下雨🌂");
        customizedcast.setBadge( 0);
        customizedcast.setSound( "default");
        customizedcast.setTestMode();//测试模式
        return client.send(customizedcast,umengVo.getMsgType());
    }

    private JSONObject androidInitParam(UmengVo umengVo) throws Exception {
        String userIds = umengVo.getUserIds();
        String msg= umengVo.getMsg();
        AndroidCustomizedcast customizedcast = new AndroidCustomizedcast(AndroidAppkey,AndroidAppkey,umengVo.getMsgType());
        if (userIds.split(",").length>500){
            String fileId = client.uploadContents(AndroidAppkey,AndroidAppkey,"aa"+"\n"+"bb"+"\n"+"alias");
            customizedcast.setFileId(fileId, "alias_type");
        }else{
            customizedcast.setAlias(userIds, "userAlias");
        }
//        String ids=StringUtils.join(userIds, ",");
        customizedcast.setTicker(msg);
        customizedcast.setTitle( "消息通知");
        customizedcast.setText(msg);
        customizedcast.goAppAfterOpen();
        customizedcast.setDisplayType(AndroidNotification.DisplayType.NOTIFICATION);
//        customizedcast.setProductionMode();
        customizedcast.setTestMode();
        //厂商通道相关参数
//        customizedcast.setChannelActivity("your channel activity");
//        customizedcast.setChannelProperties("abc");
        return client.send(customizedcast,umengVo.getMsgType());
    }



}
```

```
{
    "pushMsgInfo": {
        "msg": "人世间最美的美男子18006",
        "msgType": 0
    },
    "currentUser": {
        "userId":18006,
        "dataAuth":2,
        "institutionId":1,
         "lastLoginClient":2
    }
   
}
```

```
List<Integer> userIds = userCommonService.getUserIds();
```



controller类上加上父级url前缀   c
controller 要用构造器注入  思考autowired原因  c
方法加上注释 c
实体类使用Lombok c
restful风格获取数据用getMapping  入库操作用PostMapping c
自定义异常debug调试一下   x
泛型要加上类型 
黄色下划线注意原因修改 c
接口加上I  c
接口层加注释  c
使用注解@slf4j 合理使用Lombok c
配置要使用构造器注入 c
无用代码清除 c
equals 常量写在前面 c
多个if建议使用switch 
UmengServiceImpl方法命名更改 c
绿色下划线命名问题 
file_id忘记使用 c
key选错了 c
静态常量使用interface 类 c
\# 方法公共代码统一 c
util要用utils c
git提交主题一致
toString改为StringvalueOf
实体类属性多使用@Builder 建造者模式  xxx
使用ToString c
Mybatis的xml中froeach注意 c
APIService内部db操作的逻辑得到的结果要用参数传入 c





```xml
server:
  port: 8702

spring:
  application:
    name: sys-service-beta
  jackson:
    # 配置全局Date类型返回格式
    date-format: yyyy-MM-dd HH:mm:ss
    time-zone: GMT+8
  aop:
    proxy-target-class: true
  cloud:
    nacos:
      discovery:
        # 注册中心配置
        server-addr: 127.0.0.1:8848
#        namespace: f628db7e6b
#        # 权限校验
#        username: delta
#        password: 123456
  datasource:
    driver-class-name: com.p6spy.engine.spy.P6SpyDriver
    url: jdbc:p6spy:mysql://39.100.87.64:3306/delta_1.3_test?useUnicode=true&characterEncoding=UTF-8&zeroDateTimeBehavior=convertToNull&allowMultiQueries=true&autoReconnect=true&failOverReadOnly=false&useSSL=false
    username: delta_dev
    password: delta#1013
  redis:
    host: 118.25.27.178
    port: 6379
    database: 8
    password: sa1234
    lettuce:
      pool:
        max-idle: 5
        max-wait: 3000ms
        min-idle: 20
  servlet:
    multipart:
      # 单个文件大小限制
      max-file-size: 10MB
      # 单次请求总大小
      max-request-size: 20MB
  # activiti流程引擎配置
  activiti:
    check-process-definitions: false
    database-schema: delta_beta
    database-schema-update: flase
    db-identity-used: false
    async-executor-activate: false
    history-level: audit
  image:
    prefix: http://118.25.27.178:9000/public/
    platform:
      baseUrl: http://10.98.14.61:8080
      gateWay: /open-api/api
      uploadUrl: /upload/H5UploadPage
      showUrl: /upload/H5ViewPage
      getImages: /upload/GetImageByImageIds
      getImagesByBusinessId: /upload/GetImagesByBusinessNo
  # 伽马贷后接口
  gamma:
    url: http://testapi.che300.com/service/common/eval
    token: a36b7d4d4611c99e0b6c396e309edaff
    switch: true

thirdParty:
  # 徽商简易风险推送
  huishang:
    isPush: true
    request-url: http://39.100.13.197/hs
    riskUrl: /hsuc/dorado/alertor.do
  gps:
    # 万位
    ww-gps-token: tzcdx2sptbry5hp64jyltxbmpjf8c0kd
    ww-gps-order-url: http://114.67.94.187:15000/api/dms/dd/add
    ww-gps-cancel-url: http://114.67.94.187:15000/api/dms/dd/cancel
    ww-gps-view-url: http://114.67.94.187:15000/api/dms/dd/query
    ww-gps-equipment-url: http://114.67.94.187:15000/api/dd/device
    ww-gps-track-url: http://114.67.94.187:15000/api/dd/trail

  car-assess:
    system-name: huishang

  decision-engine:
    risk-category-id: 3631
#发短信/邮件
sendMessage:
  decision:
    mobiles: empty
    emailAddresses: omega_notify@che300.com
  reboot: # 重启进件通知人
    environment: 测试
    mobiles: empty
    emailAddresses: omega_notify@che300.com
  decision-fail:
    email-addresses: omega_notify@che300.com
  portrait-compare: #身份核查失败
    email: ryli@che300.com,hcwang@che300.com,myliu@che300.com
  #伽马报告网页截图
  gamma-report-pic:
    email: ryli@che300.com,myliu@che300.com

callback:
  huishang:
    token: 954c6e6bcb0d4e3e810ce7d3947ec5ed

mybatis:
  mapper-locations: classpath:mybatis/mapper/*/*/*.xml
  config-location: classpath:mybatis/mybatis-config.xml

spring.mvc.view:
  prefix: /
  suffix: .html

assign:
  bigDataQueryCount: 4

logging:
  config: classpath:log4j2.xml

```

